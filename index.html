<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Roommate Expense Tracker - Split and manage shared expenses with ease">
    <meta name="theme-color" content="#0284c7">

    <title>Roommate Expenses - Smart Expense Tracker</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        /* App Loading Screen */
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .app-loading p {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="app-loading" id="appLoading">
        <div class="loading-spinner"></div>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading...</p>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-main">
                <button class="icon-btn menu-toggle" aria-label="Menu" id="menuToggle">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <div class="header-title">
                    <h1>Roommate Expenses</h1>
                    <div class="current-month" id="currentMonthDisplay">Loading...</div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn theme-toggle" aria-label="Toggle theme" id="themeToggle">
                        <svg class="theme-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path class="moon" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                            <circle class="sun" cx="12" cy="12" r="5" />
                        </svg>
                    </button>
                    <button class="icon-btn" aria-label="Export data" id="exportBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="month-navigation">
                <button class="nav-btn" id="prevMonthBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6" />
                    </svg>
                </button>
                <div class="month-display">
                    <span id="currentMonthName">Loading...</span>
                </div>
                <button class="nav-btn" id="nextMonthBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <div class="stat-label">Total This Month</div>
                        <div class="stat-value">‚Çπ<span id="totalExpense">0.00</span></div>
                    </div>
                </div>
                <div class="stat-card secondary">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <div class="stat-label">Per Person</div>
                        <div class="stat-value">‚Çπ<span id="averageExpense">0.00</span></div>
                    </div>
                </div>
            </section>

            <!-- Balances -->
            <section class="section">
                <div class="section-header">
                    <h2>Current Balances</h2>
                    <button class="text-btn" id="viewDetailedBalances">View All</button>
                </div>
                <div class="balances-container" id="balancesContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-message">No balances to show</div>
                    </div>
                </div>
            </section>

            <!-- Settlement Suggestions -->
            <section class="section">
                <div class="section-header">
                    <h2>Settlement Suggestions</h2>
                    <span class="badge" id="settlementCount">0</span>
                </div>
                <div class="settlements-list" id="settlementsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div class="empty-state-message">All settled up!</div>
                    </div>
                </div>
            </section>

            <!-- Recent Expenses -->
            <section class="section">
                <div class="section-header">
                    <h2>Recent Expenses</h2>
                    <a href="add-expense.html" class="text-btn">Add New</a>
                </div>
                <div class="expenses-list" id="recentExpenses">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-message">No expenses yet</div>
                        <a href="add-expense.html" class="btn primary-btn mt-3">Add First Expense</a>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <button class="action-btn" onclick="location.href='add-expense.html'">
                    <span class="action-icon">‚ûï</span>
                    <span class="action-label">Add Expense</span>
                </button>
                <button class="action-btn" onclick="location.href='summary.html'">
                    <span class="action-icon">üìä</span>
                    <span class="action-label">View Reports</span>
                </button>
                <button class="action-btn" id="quickSettle">
                    <span class="action-icon">üí∏</span>
                    <span class="action-label">Quick Settle</span>
                </button>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <svg class="nav-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="add-expense.html" class="nav-item">
                <svg class="nav-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                <span class="nav-label">Add</span>
            </a>
            <a href="summary.html" class="nav-item">
                <svg class="nav-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                    <path d="M22 12A10 10 0 0 0 12 2v10z" />
                </svg>
                <span class="nav-label">Reports</span>
            </a>
            <a href="settings.html" class="nav-item">
                <svg class="nav-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
                <span class="nav-label">Settings</span>
            </a>
        </nav>

        <!-- Side Menu -->
        <div class="side-menu-overlay" id="sideMenuOverlay"></div>
        <aside class="side-menu" id="sideMenu">
            <div class="menu-header">
                <h3>Menu</h3>
                <button class="icon-btn close-menu" id="closeMenuBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="menu-content">
                <a href="manage-members.html" class="menu-item">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    <span>Manage Roommates</span>
                </a>
                <a href="manage-presence.html" class="menu-item">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    <span>Manage Presence</span>
                </a>
                <a href="settings.html#pin" class="menu-item">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>
                    <span>PIN Lock</span>
                </a>
                <button class="menu-item" id="exportDataBtn">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    <span>Export Data</span>
                </button>
                <button class="menu-item" id="exportCSVBtn">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M3 6h18M3 12h18m-9 6v.01M6 18h12" />
                    </svg>
                    <span>Export as CSV</span>
                </button>
                <button class="menu-item" id="importDataBtn">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <span>Import Data</span>
                </button>
                <button class="menu-item" id="clearDataBtn">
                    <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                    </svg>
                    <span>Clear All Data</span>
                </button>
                <div class="menu-footer">
                    <div class="app-version">v1.0.0</div>
                </div>
            </div>
        </aside>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Modals -->
        <div class="modal-overlay" id="modalOverlay" style="display: none;"></div>

        <div class="modal" id="exportModal" style="display: none;">
            <div class="modal-header">
                <h3>Export Data</h3>
                <button class="icon-btn close-modal" data-modal="exportModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="exportDataText" readonly rows="10" class="textarea"></textarea>
                <button class="btn primary-btn full-width" id="copyExportBtn">Copy to Clipboard</button>
                <button class="btn secondary-btn full-width mt-2" id="downloadExportBtn">Download as File</button>
            </div>
        </div>

        <div class="modal" id="importModal" style="display: none;">
            <div class="modal-header">
                <h3>Import Data</h3>
                <button class="icon-btn close-modal" data-modal="importModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="importDataText" rows="10" class="textarea"
                    placeholder="Paste your export data here..."></textarea>
                <div class="modal-actions">
                    <button class="btn secondary-btn close-modal" data-modal="importModal">Cancel</button>
                    <button class="btn primary-btn" id="confirmImportBtn">Import Data</button>
                </div>
            </div>
        </div>

        <div class="modal" id="clearDataModal" style="display: none;">
            <div class="modal-header">
                <h3>Clear All Data</h3>
                <button class="icon-btn close-modal" data-modal="clearDataModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                        <line x1="12" y1="9" x2="12" y2="13" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    <p>This will delete ALL data including expenses, members, and settings. This action cannot be
                        undone.</p>
                </div>
                <div class="modal-actions">
                    <button class="btn secondary-btn close-modal" data-modal="clearDataModal">Cancel</button>
                    <button class="btn danger-btn" id="confirmClearBtn">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/members.js"></script>
    <script src="js/presence.js"></script>
    <script src="js/expense.js"></script>
    <script src="js/calculate.js"></script>
    <script src="js/settlement.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/pwa.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Hide loading screen and show app
            setTimeout(function () {
                const appLoading = document.getElementById('appLoading');
                const appContainer = document.getElementById('appContainer');

                if (appLoading) appLoading.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';

                // Initialize the app
                if (typeof initApp === 'function') {
                    initApp();
                }
            }, 300);
        });

        // Handle service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function (registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function (err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Initialize application
        function initApp() {
            // Setup event listeners
            setupEventListeners();

            // Load initial data
            loadDashboardData();

            // Setup month navigation
            setupMonthNavigation();
        }

        function setupEventListeners() {
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sideMenu = document.getElementById('sideMenu');
            const sideMenuOverlay = document.getElementById('sideMenuOverlay');
            const closeMenuBtn = document.getElementById('closeMenuBtn');

            if (menuToggle && sideMenu) {
                menuToggle.addEventListener('click', () => {
                    sideMenu.classList.add('active');
                    sideMenuOverlay.classList.add('active');
                });

                closeMenuBtn.addEventListener('click', () => {
                    sideMenu.classList.remove('active');
                    sideMenuOverlay.classList.remove('active');
                });

                sideMenuOverlay.addEventListener('click', () => {
                    sideMenu.classList.remove('active');
                    sideMenuOverlay.classList.remove('active');
                });
            }

            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Export buttons
            const exportBtn = document.getElementById('exportBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const exportCSVBtn = document.getElementById('exportCSVBtn');

            if (exportBtn) exportBtn.addEventListener('click', showExportModal);
            if (exportDataBtn) exportDataBtn.addEventListener('click', showExportModal);
            if (exportCSVBtn) exportCSVBtn.addEventListener('click', exportToCSV);

            // Import button
            const importDataBtn = document.getElementById('importDataBtn');
            if (importDataBtn) importDataBtn.addEventListener('click', showImportModal);

            // Clear data button
            const clearDataBtn = document.getElementById('clearDataBtn');
            if (clearDataBtn) clearDataBtn.addEventListener('click', showClearDataModal);

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function () {
                    const modalId = this.getAttribute('data-modal');
                    closeModal(modalId);
                });
            });

            // Modal overlay
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', function () {
                    closeAllModals();
                });
            }

            // Quick settle
            const quickSettle = document.getElementById('quickSettle');
            if (quickSettle) {
                quickSettle.addEventListener('click', function () {
                    alert('Quick settle feature would process all pending settlements.');
                });
            }
        }

        function setupMonthNavigation() {
            const prevBtn = document.getElementById('prevMonthBtn');
            const nextBtn = document.getElementById('nextMonthBtn');

            if (prevBtn) {
                prevBtn.addEventListener('click', navigateMonth.bind(null, -1));
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', navigateMonth.bind(null, 1));
            }
        }

        function navigateMonth(direction) {
            // This would update the current month and reload data
            console.log('Navigate month:', direction);
            // In a real app, this would update the current month and reload dashboard
            loadDashboardData();
        }

        function loadDashboardData() {
            // Update month display
            updateMonthDisplay();

            // Load data from storage
            const storage = window.storage;
            if (!storage) return;

            const members = storage.getMembers();
            const expenses = storage.getExpenses();
            const currentMonth = getCurrentMonthKey();
            const monthExpenses = expenses[currentMonth] || [];

            // Update stats
            updateStats(monthExpenses, members);

            // Update balances
            updateBalances(monthExpenses, members);

            // Update settlements
            updateSettlements(monthExpenses, members);

            // Update recent expenses
            updateRecentExpenses(monthExpenses);
        }

        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function updateMonthDisplay() {
            const now = new Date();
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const monthName = monthNames[now.getMonth()];
            const year = now.getFullYear();

            const monthDisplay = document.getElementById('currentMonthDisplay');
            const monthNameElement = document.getElementById('currentMonthName');

            if (monthDisplay) monthDisplay.textContent = `${monthName} ${year}`;
            if (monthNameElement) monthNameElement.textContent = `${monthName} ${year}`;
        }

        function updateStats(expenses, members) {
            const totalElement = document.getElementById('totalExpense');
            const averageElement = document.getElementById('averageExpense');

            if (!totalElement || !averageElement) return;

            const total = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const average = members.length > 0 ? total / members.length : 0;

            totalElement.textContent = total.toFixed(2);
            averageElement.textContent = average.toFixed(2);
        }

        function updateBalances(expenses, members) {
            const container = document.getElementById('balancesContainer');
            if (!container) return;

            if (expenses.length === 0 || members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-message">No balances to show</div>
                    </div>
                `;
                return;
            }

            // Calculate balances
            const balances = calculateBalances(expenses, members);

            // Display balances
            let html = '';
            members.forEach(member => {
                const balance = balances[member.id] || 0;
                const isPositive = balance >= 0;
                const amountClass = isPositive ? 'positive' : 'negative';
                const amountText = isPositive ?
                    `+‚Çπ${Math.abs(balance).toFixed(2)}` :
                    `-‚Çπ${Math.abs(balance).toFixed(2)}`;

                html += `
                    <div class="balance-card ${isPositive ? 'positive' : 'negative'}">
                        <div class="member-avatar" style="background-color: ${member.color || '#3B82F6'}">
                            ${member.avatar || member.name.charAt(0)}
                        </div>
                        <div class="balance-info">
                            <div class="member-name">${member.name}</div>
                            <div class="balance-amount ${amountClass}">${amountText}</div>
                        </div>
                        <div class="balance-status ${isPositive ? 'present' : 'absent'}">
                            ${isPositive ? 'Will Receive' : 'Owes'}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function calculateBalances(expenses, members) {
            const balances = {};

            // Initialize balances
            members.forEach(member => {
                balances[member.id] = 0;
            });

            // Calculate balances from expenses
            expenses.forEach(expense => {
                const paidBy = expense.paidBy;
                const amount = expense.amount || 0;

                // Add to payer's balance
                balances[paidBy] = (balances[paidBy] || 0) + amount;

                // Subtract from participants
                const participants = expense.splitBetween || [];
                const participantCount = participants.length;

                if (participantCount > 0) {
                    let splitAmount = 0;

                    if (expense.splitType === 'equal') {
                        splitAmount = amount / participantCount;
                    } else if (expense.splitDetails) {
                        // Use pre-calculated split details
                        participants.forEach(participantId => {
                            const participantShare = expense.splitDetails[participantId] || 0;
                            balances[participantId] = (balances[participantId] || 0) - participantShare;
                        });
                        return; // Skip the default calculation below
                    }

                    // Default equal split calculation
                    participants.forEach(participantId => {
                        if (participantId !== paidBy) {
                            balances[participantId] = (balances[participantId] || 0) - splitAmount;
                        }
                    });
                }
            });

            return balances;
        }

        function updateSettlements(expenses, members) {
            const container = document.getElementById('settlementsList');
            const countElement = document.getElementById('settlementCount');

            if (!container) return;

            if (expenses.length === 0 || members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div class="empty-state-message">All settled up!</div>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }

            // Calculate settlements
            const balances = calculateBalances(expenses, members);
            const settlements = calculateSettlements(balances, members);

            if (settlements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div class="empty-state-message">All balances are settled!</div>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }

            // Display settlements
            let html = '';
            settlements.forEach(settlement => {
                html += `
                    <div class="settlement-item">
                        <div class="settlement-info">
                            <div class="member-avatar-small" style="background-color: ${settlement.fromColor}">
                                ${settlement.fromAvatar}
                            </div>
                            <span class="settlement-arrow">‚Üí</span>
                            <div class="member-avatar-small" style="background-color: ${settlement.toColor}">
                                ${settlement.toAvatar}
                            </div>
                        </div>
                        <div class="settlement-amount">‚Çπ${settlement.amount.toFixed(2)}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            if (countElement) countElement.textContent = settlements.length.toString();
        }

        function calculateSettlements(balances, members) {
            const settlements = [];
            const creditors = [];
            const debtors = [];

            // Separate creditors and debtors
            members.forEach(member => {
                const balance = balances[member.id] || 0;
                if (balance > 0.01) {
                    creditors.push({
                        id: member.id,
                        name: member.name,
                        avatar: member.avatar || member.name.charAt(0),
                        color: member.color || '#3B82F6',
                        amount: balance
                    });
                } else if (balance < -0.01) {
                    debtors.push({
                        id: member.id,
                        name: member.name,
                        avatar: member.avatar || member.name.charAt(0),
                        color: member.color || '#3B82F6',
                        amount: -balance
                    });
                }
            });

            // Sort by amount (largest first)
            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);

            // Calculate settlements
            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];

                const settleAmount = Math.min(creditor.amount, debtor.amount);

                if (settleAmount > 0.01) {
                    settlements.push({
                        from: debtor.name,
                        fromAvatar: debtor.avatar,
                        fromColor: debtor.color,
                        to: creditor.name,
                        toAvatar: creditor.avatar,
                        toColor: creditor.color,
                        amount: settleAmount
                    });

                    creditor.amount -= settleAmount;
                    debtor.amount -= settleAmount;
                }

                if (creditor.amount < 0.01) i++;
                if (debtor.amount < 0.01) j++;
            }

            return settlements;
        }

        function updateRecentExpenses(expenses) {
            const container = document.getElementById('recentExpenses');
            if (!container) return;

            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-message">No expenses yet</div>
                        <a href="add-expense.html" class="btn primary-btn mt-3">Add First Expense</a>
                    </div>
                `;
                return;
            }

            // Get recent expenses (last 5)
            const recent = expenses
                .sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt))
                .slice(0, 5);

            // Get members for display
            const storage = window.storage;
            const members = storage ? storage.getMembers() : [];

            let html = '';
            recent.forEach(expense => {
                const payer = members.find(m => m.id === expense.paidBy);
                const payerName = payer ? payer.name : 'Unknown';
                const date = new Date(expense.date || expense.createdAt);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short'
                });
                const categoryIcon = getCategoryIcon(expense.category);

                html += `
                    <div class="expense-item">
                        <div class="expense-icon">
                            ${categoryIcon}
                        </div>
                        <div class="expense-details">
                            <div class="expense-title">${expense.title || 'Untitled'}</div>
                            <div class="expense-meta">
                                <span>Paid by ${payerName}</span>
                                <span>‚Ä¢</span>
                                <span>${formattedDate}</span>
                            </div>
                        </div>
                        <div class="expense-amount">‚Çπ${(expense.amount || 0).toFixed(2)}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getCategoryIcon(category) {
            const icons = {
                'Food': 'üçï',
                'Rent': 'üè†',
                'Bill': 'üì±',
                'Gas': 'üî•',
                'Drinking Water': 'üíß',
                'Travel': 'üöó',
                'Other': 'üì¶',
                'Settlement': 'üí∏'
            };
            return icons[category] || 'üí∞';
        }

        function exportToCSV() {
            try {
                const storage = window.storage;
                if (!storage || !window.Utils) return;

                const expenses = Object.values(storage.getExpenses()).flat();

                if (expenses.length === 0) {
                    showToast('No expenses to export', 'info');
                    return;
                }

                window.Utils.exportToCSV(
                    expenses,
                    `roommate-expenses-${new Date().toISOString().split('T')[0]}.csv`
                );

                showToast('Expenses exported as CSV', 'success');
            } catch (error) {
                console.error('Error exporting to CSV:', error);
                showToast('Failed to export CSV: ' + error.message, 'error');
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);

            // Save preference
            const storage = window.storage;
            if (storage) {
                const settings = storage.getSettings() || {};
                storage.saveSettings({ ...settings, theme: newTheme });
            }
        }

        function showExportModal() {
            const storage = window.storage;
            if (!storage) return;

            const exportData = storage.exportData('json');
            const exportText = document.getElementById('exportDataText');
            if (exportText) {
                exportText.value = exportData;
            }

            openModal('exportModal');

            // Setup copy button
            const copyBtn = document.getElementById('copyExportBtn');
            if (copyBtn) {
                copyBtn.onclick = function () {
                    exportText.select();
                    document.execCommand('copy');
                    showToast('Copied to clipboard!', 'success');
                };
            }

            // Setup download button
            const downloadBtn = document.getElementById('downloadExportBtn');
            if (downloadBtn) {
                downloadBtn.onclick = function () {
                    const blob = new Blob([exportData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `roommate-expenses-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Download started!', 'success');
                };
            }
        }

        function showImportModal() {
            openModal('importModal');

            // Setup import button
            const importBtn = document.getElementById('confirmImportBtn');
            if (importBtn) {
                importBtn.onclick = function () {
                    const importText = document.getElementById('importDataText');
                    if (!importText || !importText.value.trim()) {
                        showToast('Please paste export data', 'error');
                        return;
                    }

                    try {
                        const storage = window.storage;
                        if (storage) {
                            storage.importData(importText.value, 'json');
                            showToast('Data imported successfully!', 'success');
                            closeModal('importModal');
                            loadDashboardData();
                        }
                    } catch (error) {
                        showToast('Import failed: ' + error.message, 'error');
                    }
                };
            }
        }

        function showClearDataModal() {
            openModal('clearDataModal');

            // Setup clear button
            const clearBtn = document.getElementById('confirmClearBtn');
            if (clearBtn) {
                clearBtn.onclick = function () {
                    const storage = window.storage;
                    if (storage) {
                        storage.clearAllData();
                        showToast('All data cleared', 'success');
                        closeModal('clearDataModal');
                        loadDashboardData();
                    }
                };
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('modalOverlay');

            if (modal && overlay) {
                modal.style.display = 'block';
                overlay.style.display = 'block';

                // Add active class for animation
                setTimeout(() => {
                    modal.classList.add('active');
                    overlay.classList.add('active');
                }, 10);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('modalOverlay');

            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                    // Check if any other modals are open
                    const anyModalOpen = Array.from(document.querySelectorAll('.modal'))
                        .some(m => m.style.display === 'block');
                    if (!anyModalOpen && overlay) {
                        overlay.style.display = 'none';
                        overlay.classList.remove('active');
                    }
                }, 300);
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            });

            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.classList.remove('active');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `;

            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);

            // Close button
            const closeBtn = toast.querySelector('.toast-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    toast.style.animation = 'toastSlideOut 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode === container) {
                            container.removeChild(toast);
                        }
                    }, 300);
                });
            }

            // Add animation style if not present
            if (!document.getElementById('toastAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
                style.textContent = `
                    @keyframes toastSlideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
    </script>
</body>

</html>